name: Deploy to westus01
on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'
      - 'cloud/opc/westus01/**'
      - '.github/workflows/deploy-to-westus01.yml'

jobs:
  publish_data-collector:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: docker/setup-buildx-action@v1
      - uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Publish data-collector to registry
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          context: backend
          file: backend/kb-data-collector.Dockerfile
          push: true
          tags: piotrwest/kb-data-collector:latest

  deploy_data-collector:
    needs: [publish_data-collector]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Create firestore service accont key json
        working-directory: ./backend
        env:
          FIRESTORE_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.FIRESTORE_SERVICE_ACCOUNT_KEY_JSON }}
        run: |
          echo "$FIRESTORE_SERVICE_ACCOUNT_KEY_JSON" >> db/firestore/service-account-key.json

      - uses: webfactory/ssh-agent@master
        with:
          ssh-private-key: ${{ secrets.WESTUS01_KEY }}

      - name: Deploy services to westus01
        env:
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          LOG_COLLECTOR_TOKEN: ${{ secrets.LOG_COLLECTOR_TOKEN }}
          FIRESTORE_PROJECT_ID: ${{ secrets.FIRESTORE_PROJECT_ID }}
          MQ_ADDRESS: ${{ secrets.MQ_ADDRESS }}
          MONGO_ADDRESS: ${{ secrets.MONGO_ADDRESS }}
        run: |
          ssh -T -o StrictHostKeyChecking=no -l ${{ secrets.WESTUS01_USER }} ${{ secrets.WESTUS01_HOST }} << EOF
            uptime
            cd ~/app
            git fetch
            git reset --hard origin/master
            cd cloud/opc/westus01
            echo "CORS_ORIGINS=$CORS_ORIGINS" >> westus01.env
            echo "LOG_COLLECTOR_TOKEN=$LOG_COLLECTOR_TOKEN" >> westus01.env
            echo "FIRESTORE_PROJECT_ID=$FIRESTORE_PROJECT_ID" >> westus01.env
            echo "MQ_ADDRESS=$MQ_ADDRESS" >> westus01.env
            echo "MONGO_ADDRESS=$MONGO_ADDRESS" >> westus01.env
            docker-compose pull
            docker-compose -f docker-compose.yml -f prod.yml up -d
            docker image prune -f
          EOF
